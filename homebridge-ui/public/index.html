<ul class="nav nav-tabs mb-3" id="mainTabs" role="tablist">
  <li class="nav-item">
    <a class="nav-link active" id="config-tab" href="#config" role="tab">Configuration</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" id="maintenance-tab" href="#maintenance" role="tab">Maintenance</a>
  </li>
</ul>

<div class="tab-content" id="mainTabsContent">
  <!-- Configuration Tab -->
  <div class="tab-pane fade show active" id="config" role="tabpanel">
    <div class="card card-body">
      <form id="configForm">
        <div class="form-group">
          <label for="name">Name</label>
          <input type="text" class="form-control" id="name" placeholder="Homebridge Z-Wave USB" />
        </div>
        <div class="form-group">
          <label for="serialPort">Serial Port Path</label>
          <input type="text" class="form-control" id="serialPort" placeholder="/dev/ttyACM0" required />
          <small class="form-text text-muted">
            WARNING: Do not use /dev/ttyUSB0. Use /dev/serial/by-id/...
          </small>
        </div>

        <fieldset>
          <legend>Z-Wave Security Keys</legend>
          <p class="text-muted small">Required for secure devices (Locks, Sensors).</p>
          <button type="button" class="btn btn-outline-primary btn-sm mb-3" id="generateKeys">
            Auto-Generate Keys
          </button>

          <div class="form-group">
            <label for="S0_Legacy">S0 Legacy</label>
            <input type="text" class="form-control" id="S0_Legacy" maxlength="32" />
          </div>
          <div class="form-group">
            <label for="S2_Unauthenticated">S2 Unauthenticated</label>
            <input type="text" class="form-control" id="S2_Unauthenticated" maxlength="32" />
          </div>
          <div class="form-group">
            <label for="S2_Authenticated">S2 Authenticated</label>
            <input type="text" class="form-control" id="S2_Authenticated" maxlength="32" />
          </div>
          <div class="form-group">
            <label for="S2_AccessControl">S2 Access Control</label>
            <input type="text" class="form-control" id="S2_AccessControl" maxlength="32" />
          </div>

          <p class="text-muted small mt-3">
            Optional: Long Range specific keys (defaults to Classic S2 if empty)
          </p>
          <div class="form-group">
            <label for="S2_Authenticated_LR">S2 Authenticated (LR)</label>
            <input type="text" class="form-control" id="S2_Authenticated_LR" maxlength="32" />
          </div>
          <div class="form-group">
            <label for="S2_AccessControl_LR">S2 Access Control (LR)</label>
            <input type="text" class="form-control" id="S2_AccessControl_LR" maxlength="32" />
          </div>
        </fieldset>

        <fieldset>
          <legend>Advanced</legend>
          <div class="form-group">
            <label for="inclusionTimeoutSeconds">Inclusion Timeout (Seconds)</label>
            <input type="number" class="form-control" id="inclusionTimeoutSeconds" placeholder="60" />
          </div>

          <div class="form-check mt-3">
            <input type="checkbox" class="form-check-input" id="debug" />
            <label class="form-check-label" for="debug">Enable Verbose Driver Logging</label>
          </div>
        </fieldset>
      </form>
    </div>
  </div>

  <!-- Maintenance Tab -->
  <div class="tab-pane fade" id="maintenance" role="tabpanel">
    <div class="card card-body">
      <h5>Z-Wave Node Maintenance</h5>
      <p class="text-muted small">
        View and manage your Z-Wave nodes. Check for official firmware updates via Z-Wave JS Service.
      </p>
      <div class="alert alert-warning py-2 small" role="alert">
        <strong>Beta Feature:</strong> Z-Wave Firmware Updates are provided as-is. Use at your own risk. Feedback is welcome!
      </div>
      <div class="table-responsive">
        <table class="table table-sm" id="nodeTable">
          <thead>
            <tr>
              <th>ID</th>
              <th>Name</th>
              <th>Status</th>
              <th>Firmware</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="nodeTableBody">
            <tr>
              <td colspan="5" class="text-center">Loading nodes...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
  (async () => {
    let currentConfig = {};

    const getInt = (id, def) => {
      const el = document.getElementById(id);
      if (!el) return def;
      const val = parseInt(el.value, 10);
      return isNaN(val) ? def : val;
    };

    const getConfig = () => {
      const securityKeys = {
        S0_Legacy: document.getElementById('S0_Legacy').value,
        S2_Unauthenticated: document.getElementById('S2_Unauthenticated').value,
        S2_Authenticated: document.getElementById('S2_Authenticated').value,
        S2_AccessControl: document.getElementById('S2_AccessControl').value,
        S2_Authenticated_LR: document.getElementById('S2_Authenticated_LR').value,
        S2_AccessControl_LR: document.getElementById('S2_AccessControl_LR').value,
      };

      const newConfig = {
        ...currentConfig,
        name: document.getElementById('name').value,
        platform: 'ZWaveUSB',
        serialPort: document.getElementById('serialPort').value,
        inclusionTimeoutSeconds: getInt('inclusionTimeoutSeconds', 60),
        debug: document.getElementById('debug').checked,
      };

      if (Object.values(securityKeys).some((k) => k && k.length > 0)) {
        newConfig.securityKeys = securityKeys;
      } else {
        delete newConfig.securityKeys;
      }

      return newConfig;
    };

    const updateConfig = async () => {
      if (window.homebridge) {
        const newConfig = getConfig();
        await window.homebridge.updatePluginConfig([newConfig]);
      }
    };

    const statusMap = ['Unknown', 'Asleep', 'Awake', 'Dead', 'Alive'];

    const loadNodes = async () => {
      try {
        const nodes = await window.homebridge.request('get-nodes');
        const tbody = document.getElementById('nodeTableBody');
        tbody.innerHTML = '';

        if (!Array.isArray(nodes)) {
          tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Plugin not responding. Is it running?</td></tr>';
          return;
        }

        nodes.forEach((node) => {
          const tr = document.createElement('tr');
          const status = statusMap[node.status] || 'Unknown';
          const progress = node.firmwareProgress;

          let actionHtml = '';
          if (progress) {
            const pct = Math.round((progress.sent / progress.total) * 100);
            actionHtml = `
              <div class="progress" style="height: 20px;">
                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: ${pct}%">${pct}%</div>
              </div>
            `;
          } else if (node.nodeId === 1) {
            actionHtml = `<span class="badge badge-light">Controller</span>`;
          } else {
            actionHtml = `<button class="btn btn-sm btn-outline-primary check-update" data-nodeid="${node.nodeId}">Check Update</button>`;
          }

          tr.innerHTML = `
            <td>${node.nodeId}</td>
            <td>${node.name || node.label || 'Node ' + node.nodeId}</td>
            <td><span class="badge badge-${status === 'Alive' || status === 'Awake' ? 'success' : 'secondary'}">${status}</span></td>
            <td>${node.firmwareVersion || 'Unknown'}</td>
            <td id="node-action-${node.nodeId}">${actionHtml}</td>
          `;
          tbody.appendChild(tr);
        });

        // Add event listeners for check buttons
        document.querySelectorAll('.check-update').forEach((btn) => {
          btn.addEventListener('click', async (e) => {
            const nodeId = e.target.getAttribute('data-nodeid');
            const node = nodes.find(n => n.nodeId == nodeId);
            
            e.target.disabled = true;
            e.target.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span>';
            
            try {
              const updates = await window.homebridge.request('check-firmware', nodeId);
              if (updates && updates.length > 0) {
                const update = updates[0];
                const actionCell = document.getElementById(`node-action-${nodeId}`);
                actionCell.innerHTML = `
                  <button class="btn btn-sm btn-success start-update" data-nodeid="${nodeId}" data-update='${JSON.stringify(update)}'>
                    Update to v${update.version}
                  </button>
                  <div class="small text-muted mt-1">Found update!</div>
                `;
                
                actionCell.querySelector('.start-update').addEventListener('click', async (e) => {
                  const isBattery = !node.isListening && !node.isFrequentListening;
                  const warning = isBattery 
                    ? 'WARNING: This is a battery-powered device. You MUST manually wake it up (usually by pressing a button on the device) immediately after clicking OK to receive the update. Proceed?'
                    : 'WARNING: Firmware updates carry risk. Do not unplug the bridge or device during the process. Proceed?';

                  if (!confirm(warning)) return;
                  
                  const target = e.currentTarget;
                  const u = JSON.parse(target.getAttribute('data-update'));
                  target.disabled = true;
                  target.innerHTML = 'Starting...';
                  
                  try {
                    await window.homebridge.request('start-update', { nodeId, update: u });
                    window.homebridge.toast.success('Firmware update started!');
                    loadNodes();
                  } catch (err) {
                    window.homebridge.toast.error(err.message);
                    loadNodes();
                  }
                });
              } else {
                window.homebridge.toast.info('No updates available for this device.');
                e.target.disabled = false;
                e.target.innerHTML = 'Check Update';
              }
            } catch (err) {
              window.homebridge.toast.error(err.message);
              e.target.disabled = false;
              e.target.innerHTML = 'Check Update';
            }
          });
        });
      } catch (err) {
        const tbody = document.getElementById('nodeTableBody');
        tbody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">${err.message}</td></tr>`;
      }
    };

    const init = async () => {
      if (!window.homebridge) return;

      // Load Config
      const pluginConfig = await window.homebridge.getPluginConfig();
      currentConfig = pluginConfig[0] || { platform: 'ZWaveUSB' };
      const config = currentConfig;

      // Populate Form
      document.getElementById('name').value = config.name || 'Homebridge Z-Wave USB';
      document.getElementById('serialPort').value = config.serialPort || '';

      // Keys
      const keys = config.securityKeys || {};
      document.getElementById('S0_Legacy').value = keys.S0_Legacy || '';
      document.getElementById('S2_Unauthenticated').value = keys.S2_Unauthenticated || '';
      document.getElementById('S2_Authenticated').value = keys.S2_Authenticated || '';
      document.getElementById('S2_AccessControl').value = keys.S2_AccessControl || '';
      document.getElementById('S2_Authenticated_LR').value = keys.S2_Authenticated_LR || '';
      document.getElementById('S2_AccessControl_LR').value = keys.S2_AccessControl_LR || '';

      // Advanced
      document.getElementById('inclusionTimeoutSeconds').value =
        config.inclusionTimeoutSeconds || 60;
      document.getElementById('debug').checked = config.debug || false;

      // Auto-save on change
      document.getElementById('configForm').addEventListener('input', updateConfig);
      document.getElementById('configForm').addEventListener('change', updateConfig);

      // Generate Keys
      document.getElementById('generateKeys').addEventListener('click', () => {
        if (document.getElementById('S0_Legacy').value && !confirm('Overwrite existing keys?'))
          return;

        const gen = () => {
          const arr = new Uint8Array(16);
          window.crypto.getRandomValues(arr);
          return Array.from(arr, (b) => b.toString(16).padStart(2, '0'))
            .join('')
            .toUpperCase();
        };

        document.getElementById('S0_Legacy').value = gen();
        document.getElementById('S2_Unauthenticated').value = gen();
        document.getElementById('S2_Authenticated').value = gen();
        document.getElementById('S2_AccessControl').value = gen();
        document.getElementById('S2_Authenticated_LR').value = gen();
        document.getElementById('S2_AccessControl_LR').value = gen();

        updateConfig();
        window.homebridge.toast.success('Keys generated and configuration updated!');
      });

      // Save event listener as a backup
      window.homebridge.addEventListener('submitting', async () => {
        await updateConfig();
      });

      // Initialize nodes
      loadNodes();
      setInterval(() => {
        if (document.getElementById('maintenance').classList.contains('active')) {
          loadNodes();
        }
      }, 5000);

      // Manual tab switching logic for environments without full Bootstrap JS
      document.querySelectorAll('#mainTabs .nav-link').forEach((tab) => {
        tab.addEventListener('click', (e) => {
          e.preventDefault();
          const targetId = tab.getAttribute('href').replace('#', '');
          
          // Update Tab Active State
          document.querySelectorAll('#mainTabs .nav-link').forEach((t) => t.classList.remove('active'));
          tab.classList.add('active');

          // Update Content Active State
          document.querySelectorAll('.tab-pane').forEach((pane) => {
            pane.classList.remove('show', 'active');
          });
          const targetPane = document.getElementById(targetId);
          if (targetPane) {
            targetPane.classList.add('show', 'active');
          }

          if (targetId === 'maintenance') {
            loadNodes();
          }
        });
      });
    };

    // Try to initialize
    if (window.homebridge && window.homebridge.getPluginConfig) {
      init();
    } else if (window.homebridge) {
      window.homebridge.addEventListener('ready', init);
    } else {
      window.addEventListener('homebridgeReady', init);
    }
  })();
</script>
